<% layout("layout/page")%>
<% block("title", "Chat CSF")%>
<script src = "/socket.io/socket.io.js"></script>
<script>
    var strings = {
        'connected': '[sys][time]%time%[/time]: Вы успешно соединились к сервером как [user]%name%[/user].[/sys]',
        'userJoined': '[sys][time]%time%[/time]: Пользователь [user]%name%[/user] присоединился к чату.[/sys]',
        'messageSent': '[out][time]%time%[/time]: [user]%name%[/user]: %text%[/out]',
        'messageReceived': '[in][time]%time%[/time]: [user]%name%[/user]: %text%[/in]',
        'userSplit': '[sys][time]%time%[/time]: Пользователь [user]%name%[/user] покинул чат.[/sys]'
    };
    var socket = io.connect('', {
        reconnect: false,
        transports: [
            'websocket',
            'flashsocket',
            'htmlfile',
            'xhr-polling',
            'jsonp-polling'
        ]

    });
    socket.on("message", function(msg) {
        if (msg.event == "connected")
        {
            if (localStorage['saidLogin'] == "true")
            {
                return;
            }
        }
        var text = strings[msg.event].replace(/\[([a-z]+)\]/g, '<span class="$1">')
                        .replace(/\[\/[a-z]+\]/g, '</span>').replace(/\%time\%/, msg.time).replace(/\%name\%/, msg.name)
                        .replace(/\%text\%/, unescape(msg.text).replace('<', '&lt;').replace('>', '&gt;')) + '<br>';
        $("<span>", {html: text}).appendTo($("#log"));
        localStorage['messages'] += text;
    })
</script>